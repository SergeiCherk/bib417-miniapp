<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>–ë–ò–ë-417</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Unbounded:wght@400;600;700&family=Manrope:wght@400;500;600&display=swap');

  :root {
    --bg: #0f0f14;
    --surface: #17171f;
    --surface2: #1e1e29;
    --border: rgba(255,255,255,0.07);
    --accent: #6c63ff;
    --accent2: #ff6b6b;
    --accent3: #43e97b;
    --yellow: #f9a825;
    --text: #f0f0f8;
    --muted: #6b6b88;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

  body {
    font-family: 'Manrope', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* === –®–ê–ü–ö–ê === */
  .header {
    position: sticky; top: 0; z-index: 100;
    background: rgba(15,15,20,0.94);
    backdrop-filter: blur(20px);
    border-bottom: 1px solid var(--border);
    padding: 14px 20px 10px;
  }
  .header-top {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 12px;
  }
  .logo {
    font-family: 'Unbounded', sans-serif;
    font-size: 18px; font-weight: 700; letter-spacing: -0.5px;
    background: linear-gradient(135deg, #6c63ff, #a78bfa);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .user-badge {
    display: flex; align-items: center; gap: 8px;
    background: var(--surface2);
    padding: 6px 12px 6px 8px;
    border-radius: 20px; font-size: 12px; color: var(--muted);
  }
  .user-avatar {
    width: 24px; height: 24px; border-radius: 50%;
    background: linear-gradient(135deg, #6c63ff, #a78bfa);
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: white;
  }

  /* === –§–ò–õ–¨–¢–†–´ === */
  .nav {
    display: flex; gap: 6px;
    overflow-x: auto; scrollbar-width: none; padding: 2px 0;
  }
  .nav::-webkit-scrollbar { display: none; }
  .nav-btn {
    flex-shrink: 0; padding: 7px 14px; border-radius: 20px;
    border: 1px solid var(--border); background: transparent;
    color: var(--muted); font-family: 'Manrope', sans-serif;
    font-size: 12px; font-weight: 600; cursor: pointer;
    transition: all 0.2s; white-space: nowrap;
  }
  .nav-btn.active {
    background: var(--accent); border-color: var(--accent); color: white;
    box-shadow: 0 0 20px rgba(108,99,255,0.35);
  }

  /* === –ö–û–ù–¢–ï–ù–¢ === */
  .content { padding: 14px 16px 100px; }

  .section-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 11px; font-weight: 600; color: var(--muted);
    text-transform: uppercase; letter-spacing: 0.08em;
    margin-bottom: 10px; margin-top: 4px;
  }

  /* === –ö–ê–†–¢–û–ß–ö–ò === */
  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 18px; padding: 16px; margin-bottom: 10px;
    cursor: pointer; transition: all 0.18s ease;
    animation: fadeUp 0.35s ease both;
    position: relative; overflow: hidden;
  }
  .card::before {
    content: ''; position: absolute; top: 0; left: 0;
    width: 3px; height: 100%; border-radius: 2px 0 0 2px;
  }
  .card.hw::before    { background: var(--accent); }
  .card.exam::before  { background: var(--accent2); }
  .card.credit::before{ background: var(--accent3); }
  .card.lecture::before{ background: var(--yellow); }
  .card:active { transform: scale(0.985); background: var(--surface2); }

  .card-header {
    display: flex; justify-content: space-between;
    align-items: flex-start; gap: 10px; margin-bottom: 8px;
  }
  .card-title {
    font-family: 'Unbounded', sans-serif;
    font-size: 13px; font-weight: 600; line-height: 1.35; flex: 1;
  }
  .badge {
    flex-shrink: 0; padding: 3px 9px; border-radius: 8px;
    font-size: 10px; font-weight: 700;
  }
  .badge.urgent { background: rgba(255,107,107,0.18); color: var(--accent2); }
  .badge.soon   { background: rgba(249,168,37,0.18);  color: var(--yellow); }
  .badge.ok     { background: rgba(67,233,123,0.18);  color: var(--accent3); }
  .badge.done   { background: rgba(67,233,123,0.12);  color: var(--accent3); }
  .badge.overdue{ background: rgba(107,107,136,0.15); color: var(--muted); }

  .card-meta {
    display: flex; align-items: center; gap: 12px; flex-wrap: wrap;
  }
  .meta-item { display: flex; align-items: center; gap: 4px; font-size: 11px; color: var(--muted); }

  /* === –î–ï–¢–ê–õ–¨–ù–ê–Ø –°–¢–†–ê–ù–ò–¶–ê === */
  .detail-view {
    display: none; position: fixed; inset: 0;
    background: var(--bg); z-index: 200;
    overflow-y: auto; animation: slideUp 0.28s ease;
  }
  .detail-view.open { display: block; }

  .detail-header {
    position: sticky; top: 0;
    background: rgba(15,15,20,0.96);
    backdrop-filter: blur(20px);
    padding: 16px 20px; display: flex; align-items: center;
    gap: 12px; border-bottom: 1px solid var(--border);
  }
  .back-btn {
    width: 36px; height: 36px; border-radius: 50%;
    background: var(--surface2); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text); font-size: 20px;
    flex-shrink: 0; transition: background 0.15s; line-height: 1;
  }
  .back-btn:active { background: var(--accent); }
  .detail-title-wrap { flex: 1; }
  .detail-type { font-size: 11px; color: var(--muted); margin-bottom: 2px; }
  .detail-name { font-family: 'Unbounded', sans-serif; font-size: 14px; font-weight: 700; line-height: 1.3; }

  .detail-body { padding: 18px 16px; }

  .info-block {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; padding: 4px 16px; margin-bottom: 12px;
  }
  .info-row {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 12px 0; border-bottom: 1px solid var(--border);
  }
  .info-row:last-child { border-bottom: none; }
  .info-icon { font-size: 16px; flex-shrink: 0; margin-top: 1px; }
  .info-content { flex: 1; }
  .info-label { font-size: 10px; color: var(--muted); margin-bottom: 3px; }
  .info-value { font-size: 13px; color: var(--text); line-height: 1.6; }

  .countdown-block {
    background: linear-gradient(135deg, rgba(108,99,255,0.13), rgba(167,139,250,0.08));
    border: 1px solid rgba(108,99,255,0.25);
    border-radius: 16px; padding: 18px 20px;
    text-align: center; margin-bottom: 12px;
  }
  .countdown-label { font-size: 11px; color: var(--muted); margin-bottom: 6px; }
  .countdown-value {
    font-family: 'Unbounded', sans-serif; font-size: 24px; font-weight: 700;
    background: linear-gradient(135deg, #a78bfa, #6c63ff);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  }
  .countdown-date { font-size: 12px; color: var(--muted); margin-top: 5px; }

  .done-btn {
    width: 100%; padding: 15px; border-radius: 14px; border: none;
    font-family: 'Unbounded', sans-serif; font-size: 12px; font-weight: 600;
    cursor: pointer; transition: all 0.2s; margin-top: 6px;
  }
  .done-btn.mark   { background: var(--accent); color: white; box-shadow: 0 4px 20px rgba(108,99,255,0.35); }
  .done-btn.unmark { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); }
  .done-btn:active { transform: scale(0.98); }

  /* === –ß–ï–ö–õ–ò–°–¢ === */
  .checklist { list-style: none; }
  .checklist-item {
    display: flex; align-items: flex-start; gap: 12px;
    padding: 10px 12px; border-radius: 12px; cursor: pointer;
    transition: background 0.15s; margin-bottom: 2px;
  }
  .checklist-item:active { background: var(--surface2); }
  .check-box {
    width: 20px; height: 20px; border-radius: 6px;
    border: 2px solid rgba(255,255,255,0.15); flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.2s; margin-top: 1px;
  }
  .checklist-item.checked .check-box {
    background: var(--accent3); border-color: var(--accent3);
  }
  .check-text { font-size: 13px; line-height: 1.5; transition: color 0.2s; }
  .checklist-item.checked .check-text { color: var(--muted); text-decoration: line-through; }

  /* === –ü–£–°–¢–û–ô –≠–ö–†–ê–ù === */
  .empty-state {
    text-align: center; padding: 60px 20px; animation: fadeUp 0.4s ease;
  }
  .empty-emoji { font-size: 44px; margin-bottom: 14px; }
  .empty-title { font-family: 'Unbounded', sans-serif; font-size: 15px; font-weight: 600; margin-bottom: 8px; }
  .empty-sub { font-size: 13px; color: var(--muted); }

  /* === –¢–ê–ë–ë–ê–† === */
  .tabbar {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: rgba(15,15,20,0.97);
    backdrop-filter: blur(20px);
    border-top: 1px solid var(--border);
    display: grid; grid-template-columns: repeat(4, 1fr);
    padding: 8px 0 20px; z-index: 100;
  }
  .tab-item {
    display: flex; flex-direction: column; align-items: center;
    gap: 3px; padding: 6px 4px; cursor: pointer;
    transition: all 0.2s;
  }
  .tab-icon { font-size: 20px; transition: transform 0.2s; }
  .tab-item.active .tab-icon { transform: scale(1.15); filter: drop-shadow(0 0 6px rgba(108,99,255,0.5)); }
  .tab-label { font-size: 9px; font-weight: 600; color: var(--muted); transition: color 0.2s; }
  .tab-item.active .tab-label { color: var(--accent); }

  /* === –ê–ù–ò–ú–ê–¶–ò–ò === */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(14px); }
    to   { opacity: 1; transform: translateY(0); }
  }
  @keyframes slideUp {
    from { transform: translateY(24px); opacity: 0; }
    to   { transform: translateY(0); opacity: 1; }
  }

  ::-webkit-scrollbar { width: 0; }
</style>
</head>
<body>

<div class="header">
  <div class="header-top">
    <div class="logo">–ë–ò–ë-417</div>
    <div class="user-badge">
      <div class="user-avatar" id="userInitial">–°</div>
      <span id="userName">–°—Ç—É–¥–µ–Ω—Ç</span>
    </div>
  </div>
  <div class="nav" id="filterNav"></div>
</div>

<div class="content" id="mainContent">
  <div style="text-align:center;padding:60px 0">
    <div style="font-size:30px;margin-bottom:10px">‚ö°Ô∏è</div>
    <div style="font-family:'Unbounded',sans-serif;font-size:13px;color:var(--muted)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>
</div>

<div class="tabbar">
  <div class="tab-item active" onclick="switchTab('hw')">
    <span class="tab-icon">üìù</span><span class="tab-label">–î–ó</span>
  </div>
  <div class="tab-item" onclick="switchTab('credits')">
    <span class="tab-icon">‚úÖ</span><span class="tab-label">–ó–∞—á—ë—Ç—ã</span>
  </div>
  <div class="tab-item" onclick="switchTab('exams')">
    <span class="tab-icon">üìö</span><span class="tab-label">–≠–∫–∑–∞–º–µ–Ω—ã</span>
  </div>
  <div class="tab-item" onclick="switchTab('lectures')">
    <span class="tab-icon">üìñ</span><span class="tab-label">–õ–µ–∫—Ü–∏–∏</span>
  </div>
</div>

<div class="detail-view" id="detailView">
  <div class="detail-header">
    <div class="back-btn" onclick="closeDetail()">‚Äπ</div>
    <div class="detail-title-wrap">
      <div class="detail-type" id="detailType"></div>
      <div class="detail-name" id="detailName"></div>
    </div>
  </div>
  <div class="detail-body" id="detailBody"></div>
</div>

<script>
// =====================================================
// TELEGRAM MINI APP ‚Äî –ë–ò–ë-417
//
// –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –±–æ—Ç–∞:
//   1. –ó–∞–¥–µ–ø–ª–æ–π—Ç–µ –±–æ—Ç–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä (–Ω–∞–ø—Ä–∏–º–µ—Ä, VPS –∏–ª–∏ Railway)
//   2. –î–æ–±–∞–≤—å—Ç–µ –≤ bot.py —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã FastAPI/aiohttp:
//      GET /api/homework  ‚Üí —Å–ø–∏—Å–æ–∫ –î–ó
//      GET /api/credits   ‚Üí –∑–∞—á—ë—Ç—ã
//      GET /api/exams     ‚Üí —ç–∫–∑–∞–º–µ–Ω—ã
//      GET /api/lectures  ‚Üí –ª–µ–∫—Ü–∏–∏
//   3. –ó–∞–º–µ–Ω–∏—Ç–µ DATA –Ω–∏–∂–µ –Ω–∞ fetch() –∑–∞–ø—Ä–æ—Å—ã –∫ –≤–∞—à–µ–º—É API
//   4. –ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–ª–∏–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ tg.initData –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ
//
// –ü–æ–∫–∞ —á—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –¥–µ–º–æ-–¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
// =====================================================

const tg = window.Telegram?.WebApp;
if (tg) { tg.expand(); tg.setHeaderColor('#0f0f14'); tg.setBackgroundColor('#0f0f14'); }

// –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Telegram
try {
  const u = JSON.parse(new URLSearchParams(tg?.initData || '').get('user') || '{}');
  if (u.first_name) {
    document.getElementById('userName').textContent = u.first_name;
    document.getElementById('userInitial').textContent = u.first_name[0].toUpperCase();
  }
} catch(e) {}

// ===== –î–ï–ú–û-–î–ê–ù–ù–´–ï (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ fetch –∫ –≤–∞—à–µ–º—É API) =====
const DATA = {
  homework: [
    { id:1, subject:"–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑", description:"–†–µ—à–∏—Ç—å –∑–∞–¥–∞—á–∏ ‚Ññ15-20 –∏–∑ –∑–∞–¥–∞—á–Ω–∏–∫–∞ –î–µ–º–∏–¥–æ–≤–∏—á–∞", deadline:"2026-02-20T23:59:00", done:false, files:["zadachi.pdf"] },
    { id:2, subject:"–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ",       description:"–ù–∞–ø–∏—Å–∞—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –ø—É–∑—ã—Ä—å–∫–æ–º –Ω–∞ Python", deadline:"2026-02-16T18:00:00", done:false, files:[] },
    { id:3, subject:"–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",            description:"ER-–¥–∏–∞–≥—Ä–∞–º–º–∞ –¥–ª—è –∑–∞–¥–∞–Ω–∏—è –∏–∑ –ª–µ–∫—Ü–∏–∏ 4", deadline:"2026-02-15T23:59:00", done:true,  files:["er_template.docx"] },
    { id:4, subject:"–î–∏—Å–∫—Ä–µ—Ç–Ω–∞—è –º–∞—Ç–µ–º–∞—Ç–∏–∫–∞",  description:"–ö–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è —Ä–∞–±–æ—Ç–∞ ‚Ññ2: –≥—Ä–∞—Ñ—ã –∏ –¥–µ—Ä–µ–≤—å—è", deadline:"2026-02-14T12:00:00", done:false, files:[] },
  ],
  credits: [
    { id:1, subject:"–§–∏–∑–∏—á–µ—Å–∫–∞—è –∫—É–ª—å—Ç—É—Ä–∞", teacher:"–ö–æ–∑–ª–æ–≤ –ê.–í.", date:"2026-05-20T10:00:00", location:"–°–ø–æ—Ä—Ç–∑–∞–ª", auto_req:"–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å –Ω–µ –º–µ–Ω–µ–µ 80%", questions:["–ü—Ä–∞–≤–∏–ª–∞ –∏–≥—Ä—ã –≤ –≤–æ–ª–µ–π–±–æ–ª","–¢–µ—Ö–Ω–∏–∫–∞ –±–µ–≥–∞","–†–∞–∑–º–∏–Ω–∫–∞"] },
    { id:2, subject:"–ò–Ω–æ—Å—Ç—Ä–∞–Ω–Ω—ã–π —è–∑—ã–∫",    teacher:"–ü–µ—Ç—Ä–æ–≤–∞ –ù.–ê.", date:"2026-05-15T14:00:00", location:"–ê—É–¥. 301",  auto_req:"–í—Å–µ –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ —Ä–∞–±–æ—Ç—ã —Å–¥–∞–Ω—ã", questions:["Present Perfect vs Past Simple","–ú–æ–¥–∞–ª—å–Ω—ã–µ –≥–ª–∞–≥–æ–ª—ã","–ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è –ª–µ–∫—Å–∏–∫–∞ IT","Listening tasks"] },
  ],
  exams: [
    { id:1, subject:"–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑", teacher:"–ò–≤–∞–Ω–æ–≤ –ò.–ò.", exam_date:"2026-06-10T09:00:00", location:"–ê—É–¥. 215", consult_date:"2026-06-08T14:00:00", questions:["–ü—Ä–µ–¥–µ–ª—ã —Ñ—É–Ω–∫—Ü–∏–π","–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ","–ò–Ω—Ç–µ–≥—Ä–∞–ª—ã","–†—è–¥—ã","–î–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ —É—Ä–∞–≤–Ω–µ–Ω–∏—è"] },
    { id:2, subject:"–ë–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö",           teacher:"–°–∏–¥–æ—Ä–æ–≤–∞ –û.–ü.", exam_date:"2026-06-15T11:00:00", location:"–ê—É–¥. 112", consult_date:"2026-06-13T13:00:00", questions:["ER-–º–æ–¥–µ–ª–∏","SQL –∑–∞–ø—Ä–æ—Å—ã","–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è","–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏","–ò–Ω–¥–µ–∫—Å—ã"] },
  ],
  lectures: [
    { id:1, subject:"–ú–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑", items:[
      { id:1, title:"–ü—Ä–µ–¥–µ–ª—ã —Ñ—É–Ω–∫—Ü–∏–π",   date:"05.09.2025", description:"–û—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–Ω—è—Ç–∏—è: –ø—Ä–µ–¥–µ–ª —Ñ—É–Ω–∫—Ü–∏–∏, –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ –ö–æ—à–∏ –∏ –ì–µ–π–Ω–µ, —Å–≤–æ–π—Å—Ç–≤–∞ –ø—Ä–µ–¥–µ–ª–æ–≤." },
      { id:2, title:"–ü—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ",       date:"12.09.2025", description:"–ü–æ–Ω—è—Ç–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–Ω–æ–π, –ø—Ä–∞–≤–∏–ª–∞ –¥–∏—Ñ—Ñ–µ—Ä–µ–Ω—Ü–∏—Ä–æ–≤–∞–Ω–∏—è, –ø—Ä–æ–∏–∑–≤–æ–¥–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç–∞—Ä–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π." },
      { id:3, title:"–ò–Ω—Ç–µ–≥—Ä–∞–ª—ã",         date:"19.09.2025", description:"–ù–µ–æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω—ã–π –∏–Ω—Ç–µ–≥—Ä–∞–ª, —Ç–∞–±–ª–∏—Ü–∞ –∏–Ω—Ç–µ–≥—Ä–∞–ª–æ–≤, –º–µ—Ç–æ–¥—ã –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞–Ω–∏—è." },
    ]},
    { id:2, subject:"–ü—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ", items:[
      { id:4, title:"–í–≤–µ–¥–µ–Ω–∏–µ –≤ Python", date:"05.09.2025", description:"–°–∏–Ω—Ç–∞–∫—Å–∏—Å Python, —Ç–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö, –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ, –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã –≤–≤–æ–¥–∞/–≤—ã–≤–æ–¥–∞." },
      { id:5, title:"–§—É–Ω–∫—Ü–∏–∏ –∏ –º–æ–¥—É–ª–∏",  date:"12.09.2025", description:"–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ñ—É–Ω–∫—Ü–∏–π, –∞—Ä–≥—É–º–µ–Ω—Ç—ã, –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è, import." },
    ]},
  ],
};

// ===== –°–û–°–¢–û–Ø–ù–ò–ï =====
let currentTab = 'hw';
let hwFilter = 'active';
let doneHw = new Set(DATA.homework.filter(h => h.done).map(h => h.id));
let checkProgress = {}; // { "credit_1": Set, "exam_1": Set }
let selectedSubjectId = null;

// ===== –£–¢–ò–õ–ò–¢–´ =====
function timeLeft(dateStr) {
  const diff = new Date(dateStr) - new Date();
  if (diff < 0) return { label:"–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ", type:"overdue" };
  const d = Math.floor(diff/86400000), h = Math.floor((diff%86400000)/3600000);
  const m = Math.floor((diff%3600000)/60000);
  if (d > 7)  return { label:`${d} –¥–Ω–µ–π`, type:"ok" };
  if (d >= 3) return { label:`${d} –¥–Ω. ${h} —á.`, type:"soon" };
  if (d >= 1) return { label:`${d} –¥–Ω. ${h} —á.`, type:"urgent" };
  if (h >= 1) return { label:`${h} —á. ${m} –º–∏–Ω.`, type:"urgent" };
  return { label:`${m} –º–∏–Ω.!`, type:"urgent" };
}

function fmtDate(s, noTime=false) {
  if (!s) return "‚Äî";
  const d = new Date(s);
  const date = d.toLocaleDateString('ru-RU', {day:'2-digit',month:'2-digit',year:'numeric'});
  if (noTime) return date;
  const time = d.toLocaleTimeString('ru-RU', {hour:'2-digit',minute:'2-digit'});
  return `${date} ${time}`;
}

function haptic() { tg?.HapticFeedback?.impactOccurred('light'); }

function setNav(items, active, fn) {
  document.getElementById('filterNav').innerHTML = items.map(it =>
    `<button class="nav-btn ${it.k===active?'active':''}" onclick="${fn}('${it.k}')">${it.l}</button>`
  ).join('');
}

// ===== –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–ï –í–ö–õ–ê–î–û–ö =====
function switchTab(tab) {
  currentTab = tab; selectedSubjectId = null;
  document.querySelectorAll('.tab-item').forEach((el,i) => {
    el.classList.toggle('active', ['hw','credits','exams','lectures'][i] === tab);
  });
  renderContent();
}

function renderContent() {
  const fns = { hw:renderHW, credits:renderCredits, exams:renderExams, lectures:renderLectures };
  fns[currentTab]?.();
}

// ===================== –î–ó =====================
function renderHW() {
  setNav([
    {k:'active',l:'‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ'},{k:'all',l:'üìã –í—Å–µ'},
    {k:'overdue',l:'‚è∞ –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ'},{k:'done',l:'‚úîÔ∏è –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ'}
  ], hwFilter, 'setHwFilter');

  const now = new Date();
  const list = DATA.homework.filter(hw => {
    const dl = new Date(hw.deadline), isDone = doneHw.has(hw.id);
    if (hwFilter==='active')  return !isDone && dl > now;
    if (hwFilter==='overdue') return !isDone && dl <= now;
    if (hwFilter==='done')    return isDone;
    return true;
  });

  if (!list.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty-state"><div class="empty-emoji">üéâ</div><div class="empty-title">–ù–µ—Ç –∑–∞–¥–∞–Ω–∏–π</div><div class="empty-sub">–í —ç—Ç–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –ø—É—Å—Ç–æ</div></div>`;
    return;
  }

  document.getElementById('mainContent').innerHTML = list.map((hw, i) => {
    const tl = timeLeft(hw.deadline), isDone = doneHw.has(hw.id);
    return `
      <div class="card hw" style="animation-delay:${i*0.05}s" onclick="openHW(${hw.id})">
        <div class="card-header">
          <div class="card-title">${hw.subject}</div>
          <span class="badge ${isDone?'done':tl.type}">${isDone?'‚úì –°–¥–∞–Ω–æ':tl.label}</span>
        </div>
        <div class="card-meta">
          <div class="meta-item">üìÖ ${fmtDate(hw.deadline)}</div>
          ${hw.files.length ? `<div class="meta-item">üìé ${hw.files.length} —Ñ–∞–π–ª(–∞)</div>` : ''}
        </div>
      </div>`;
  }).join('');
}

function setHwFilter(f) { hwFilter = f; renderHW(); }

function openHW(id) {
  const hw = DATA.homework.find(h => h.id === id);
  if (!hw) return;
  const isDone = doneHw.has(id), tl = timeLeft(hw.deadline);
  document.getElementById('detailType').textContent = 'üìù –î–æ–º–∞—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ';
  document.getElementById('detailName').textContent = hw.subject;
  document.getElementById('detailBody').innerHTML = `
    <div class="countdown-block">
      <div class="countdown-label">–î–æ —Å–¥–∞—á–∏</div>
      <div class="countdown-value">${tl.label}</div>
      <div class="countdown-date">–°—Ä–æ–∫: ${fmtDate(hw.deadline)}</div>
    </div>
    <div class="info-block">
      <div class="info-row">
        <span class="info-icon">üìã</span>
        <div class="info-content">
          <div class="info-label">–ó–∞–¥–∞–Ω–∏–µ</div>
          <div class="info-value">${hw.description}</div>
        </div>
      </div>
      ${hw.files.length ? `<div class="info-row">
        <span class="info-icon">üìé</span>
        <div class="info-content">
          <div class="info-label">–§–∞–π–ª—ã</div>
          <div class="info-value">${hw.files.join(', ')}</div>
        </div>
      </div>` : ''}
    </div>
    <button class="done-btn ${isDone?'unmark':'mark'}" onclick="toggleHW(${id})">
      ${isDone ? '‚Ü©Ô∏è –û—Ç–º–µ—Ç–∏—Ç—å –Ω–µ–≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º' : '‚úÖ –û—Ç–º–µ—Ç–∏—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–º'}
    </button>`;
  openDetail();
}

function toggleHW(id) {
  haptic();
  if (doneHw.has(id)) doneHw.delete(id); else doneHw.add(id);
  tg?.sendData?.(JSON.stringify({action:'toggle_hw', hw_id:id, done:doneHw.has(id)}));
  openHW(id);
}

// ===================== –ó–ê–ß–Å–¢–´ =====================
function renderCredits() {
  document.getElementById('filterNav').innerHTML = '';
  if (!DATA.credits.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty-state"><div class="empty-emoji">‚úÖ</div><div class="empty-title">–ó–∞—á—ë—Ç–æ–≤ –Ω–µ—Ç</div><div class="empty-sub">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª</div></div>`;
    return;
  }
  document.getElementById('mainContent').innerHTML =
    `<div class="section-title">–ó–∞—á—ë—Ç—ã</div>` +
    DATA.credits.map((cr, i) => {
      const tl = timeLeft(cr.date);
      return `
        <div class="card credit" style="animation-delay:${i*0.06}s" onclick="openCredit(${cr.id})">
          <div class="card-header">
            <div class="card-title">${cr.subject}</div>
            <span class="badge ${tl.type}">${tl.label}</span>
          </div>
          <div class="card-meta">
            <div class="meta-item">üë§ ${cr.teacher}</div>
            <div class="meta-item">üìÖ ${fmtDate(cr.date)}</div>
          </div>
          <div class="card-meta" style="margin-top:5px">
            <div class="meta-item">üìç ${cr.location}</div>
            <div class="meta-item">üìã ${cr.questions.length} –≤–æ–ø—Ä–æ—Å–æ–≤</div>
          </div>
        </div>`;
    }).join('');
}

function openCredit(id) {
  const cr = DATA.credits.find(c => c.id === id);
  if (!cr) return;
  const key = `credit_${id}`;
  if (!checkProgress[key]) checkProgress[key] = new Set();
  document.getElementById('detailType').textContent = '‚úÖ –ó–∞—á—ë—Ç';
  document.getElementById('detailName').textContent = cr.subject;
  document.getElementById('detailBody').innerHTML = `
    <div class="info-block">
      <div class="info-row"><span class="info-icon">üë§</span><div class="info-content"><div class="info-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</div><div class="info-value">${cr.teacher}</div></div></div>
      <div class="info-row"><span class="info-icon">üìÖ</span><div class="info-content"><div class="info-label">–î–∞—Ç–∞ –∑–∞—á—ë—Ç–∞</div><div class="info-value">${fmtDate(cr.date)}</div></div></div>
      <div class="info-row"><span class="info-icon">üìç</span><div class="info-content"><div class="info-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</div><div class="info-value">${cr.location}</div></div></div>
      <div class="info-row"><span class="info-icon">üèÜ</span><div class="info-content"><div class="info-label">–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∞</div><div class="info-value">${cr.auto_req}</div></div></div>
    </div>
    <div class="section-title">–í–æ–ø—Ä–æ—Å—ã –∫ –∑–∞—á—ë—Ç—É</div>
    <ul class="checklist">
      ${cr.questions.map((q,i) => `
        <li class="checklist-item ${checkProgress[key].has(i)?'checked':''}" onclick="toggleCheck('credit',${id},${i})">
          <div class="check-box">${checkProgress[key].has(i)?'<svg width="10" height="8" viewBox="0 0 10 8"><path d="M1 3.5l2.5 2.5L9 1" stroke="white" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>':''}</div>
          <span class="check-text">${i+1}. ${q}</span>
        </li>`).join('')}
    </ul>`;
  openDetail();
}

// ===================== –≠–ö–ó–ê–ú–ï–ù–´ =====================
function renderExams() {
  document.getElementById('filterNav').innerHTML = '';
  if (!DATA.exams.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty-state"><div class="empty-emoji">üìö</div><div class="empty-title">–≠–∫–∑–∞–º–µ–Ω–æ–≤ –Ω–µ—Ç</div><div class="empty-sub">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä –µ—â—ë –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–±–∞–≤–∏–ª</div></div>`;
    return;
  }
  document.getElementById('mainContent').innerHTML =
    `<div class="section-title">–≠–∫–∑–∞–º–µ–Ω—ã</div>` +
    DATA.exams.map((ex, i) => {
      const tl = timeLeft(ex.exam_date);
      return `
        <div class="card exam" style="animation-delay:${i*0.06}s" onclick="openExam(${ex.id})">
          <div class="card-header">
            <div class="card-title">${ex.subject}</div>
            <span class="badge ${tl.type}">${tl.label}</span>
          </div>
          <div class="card-meta">
            <div class="meta-item">üë§ ${ex.teacher}</div>
            <div class="meta-item">üìÖ ${fmtDate(ex.exam_date)}</div>
          </div>
          <div class="card-meta" style="margin-top:5px">
            <div class="meta-item">üìç ${ex.location}</div>
            <div class="meta-item">üìã ${ex.questions.length} –≤–æ–ø—Ä–æ—Å–æ–≤</div>
          </div>
        </div>`;
    }).join('');
}

function openExam(id) {
  const ex = DATA.exams.find(e => e.id === id);
  if (!ex) return;
  const key = `exam_${id}`, tl = timeLeft(ex.exam_date);
  if (!checkProgress[key]) checkProgress[key] = new Set();
  document.getElementById('detailType').textContent = 'üìö –≠–∫–∑–∞–º–µ–Ω';
  document.getElementById('detailName').textContent = ex.subject;
  document.getElementById('detailBody').innerHTML = `
    <div class="countdown-block">
      <div class="countdown-label">–î–æ —ç–∫–∑–∞–º–µ–Ω–∞</div>
      <div class="countdown-value">${tl.label}</div>
      <div class="countdown-date">${fmtDate(ex.exam_date)}</div>
    </div>
    <div class="info-block">
      <div class="info-row"><span class="info-icon">üë§</span><div class="info-content"><div class="info-label">–ü—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å</div><div class="info-value">${ex.teacher}</div></div></div>
      <div class="info-row"><span class="info-icon">üìç</span><div class="info-content"><div class="info-label">–ê—É–¥–∏—Ç–æ—Ä–∏—è</div><div class="info-value">${ex.location}</div></div></div>
      ${ex.consult_date ? `<div class="info-row"><span class="info-icon">üóì</span><div class="info-content"><div class="info-label">–ö–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏—è</div><div class="info-value">${fmtDate(ex.consult_date)}</div></div></div>` : ''}
    </div>
    <div class="section-title">–í–æ–ø—Ä–æ—Å—ã –∫ —ç–∫–∑–∞–º–µ–Ω—É</div>
    <ul class="checklist">
      ${ex.questions.map((q,i) => `
        <li class="checklist-item ${checkProgress[key].has(i)?'checked':''}" onclick="toggleCheck('exam',${id},${i})">
          <div class="check-box">${checkProgress[key].has(i)?'<svg width="10" height="8" viewBox="0 0 10 8"><path d="M1 3.5l2.5 2.5L9 1" stroke="white" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>':''}</div>
          <span class="check-text">${i+1}. ${q}</span>
        </li>`).join('')}
    </ul>`;
  openDetail();
}

// ===================== –õ–ï–ö–¶–ò–ò =====================
function renderLectures() {
  document.getElementById('filterNav').innerHTML = '';
  if (selectedSubjectId !== null) { renderLectureList(selectedSubjectId); return; }
  if (!DATA.lectures.length) {
    document.getElementById('mainContent').innerHTML =
      `<div class="empty-state"><div class="empty-emoji">üìñ</div><div class="empty-title">–õ–µ–∫—Ü–∏–π –Ω–µ—Ç</div><div class="empty-sub">–ú–∞—Ç–µ—Ä–∏–∞–ª—ã –µ—â—ë –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã</div></div>`;
    return;
  }
  document.getElementById('mainContent').innerHTML =
    `<div class="section-title">–ü—Ä–µ–¥–º–µ—Ç—ã</div>` +
    DATA.lectures.map((s,i) => `
      <div class="card lecture" style="animation-delay:${i*0.06}s" onclick="openSubject(${s.id})">
        <div class="card-header">
          <div class="card-title">${s.subject}</div>
          <span class="badge soon">${s.items.length} –ª–µ–∫—Ü–∏–π</span>
        </div>
      </div>`).join('');
}

function openSubject(id) { selectedSubjectId = id; renderLectureList(id); }

function renderLectureList(id) {
  const subj = DATA.lectures.find(s => s.id === id);
  if (!subj) return;
  document.getElementById('filterNav').innerHTML =
    `<button class="nav-btn active" onclick="selectedSubjectId=null;renderLectures()">‚Üê –ù–∞–∑–∞–¥</button>
     <button class="nav-btn" style="pointer-events:none;opacity:0.6">${subj.subject}</button>`;
  document.getElementById('mainContent').innerHTML =
    `<div class="section-title">${subj.subject}</div>` +
    subj.items.map((lec,i) => `
      <div class="card lecture" style="animation-delay:${i*0.06}s" onclick="openLecture(${id},${lec.id})">
        <div class="card-header">
          <div class="card-title">–õ–µ–∫—Ü–∏—è ${i+1}: ${lec.title}</div>
        </div>
        <div class="card-meta"><div class="meta-item">üìÖ ${lec.date}</div></div>
      </div>`).join('');
}

function openLecture(subjId, lecId) {
  const subj = DATA.lectures.find(s => s.id === subjId);
  const lec = subj?.items.find(l => l.id === lecId);
  if (!lec) return;
  const idx = subj.items.indexOf(lec);
  document.getElementById('detailType').textContent = `üìñ ${subj.subject}`;
  document.getElementById('detailName').textContent = `–õ–µ–∫—Ü–∏—è ${idx+1}: ${lec.title}`;
  document.getElementById('detailBody').innerHTML = `
    <div class="info-block">
      <div class="info-row"><span class="info-icon">üìÖ</span><div class="info-content"><div class="info-label">–î–∞—Ç–∞</div><div class="info-value">${lec.date}</div></div></div>
    </div>
    <div class="section-title">–ö–æ–Ω—Å–ø–µ–∫—Ç</div>
    <div class="info-block" style="padding:16px">
      <div style="font-size:13px;line-height:1.8;color:var(--text)">${lec.description}</div>
    </div>`;
  openDetail();
}

// ===================== –ß–ï–ö-–õ–ò–°–¢ =====================
function toggleCheck(type, id, idx) {
  haptic();
  const key = `${type}_${id}`;
  if (!checkProgress[key]) checkProgress[key] = new Set();
  if (checkProgress[key].has(idx)) checkProgress[key].delete(idx);
  else checkProgress[key].add(idx);

  const items = document.querySelectorAll('.checklist-item');
  const item = items[idx];
  if (!item) return;
  const checked = checkProgress[key].has(idx);
  item.classList.toggle('checked', checked);
  item.querySelector('.check-box').innerHTML = checked
    ? '<svg width="10" height="8" viewBox="0 0 10 8"><path d="M1 3.5l2.5 2.5L9 1" stroke="white" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/></svg>'
    : '';
}

// ===================== –î–ï–¢–ê–õ–¨–ù–´–ô –í–ò–î =====================
function openDetail() {
  document.getElementById('detailView').classList.add('open');
  if (tg) { tg.BackButton.show(); tg.BackButton.onClick(closeDetail); }
}
function closeDetail() {
  document.getElementById('detailView').classList.remove('open');
  if (tg) tg.BackButton.hide();
  renderContent();
}

// –°—Ç–∞—Ä—Ç
renderContent();
</script>
</body>
</html>
